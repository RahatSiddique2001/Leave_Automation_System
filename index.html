<!doctype html>
<html>

<head>
  
  <meta charset="utf-8" />
  <title>Leave Automation - Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand bg-light">
    <div class="container">
      <a class="navbar-brand" href="#">Leave System</a>
      <div>
        <button class="btn btn-outline-primary" id="open-auth">Login / Signup</button>
        <a href="apply.html" class="btn btn-primary ms-2">Apply for Leave</a>
        <a href="list.html" class="btn btn-secondary ms-2">My Requests</a>
        <!-- hidden by default; shown only for approvers (HOD / Registrar) -->
        <a href="approvals.html" id="approvals-link" class="btn btn-warning ms-2" style="display:none">Approvals</a>
      </div>
    </div>
  </nav>

  <div class="container py-5">
    <h1>Welcome</h1>
    <p>Simple Leave Automation MVP. Please log in to apply and view requests.</p>

    <div id="user-area" class="mb-3"></div>

    <div class="card p-3">
      <h4>Quick start</h4>
      <ol>
        <li>Click <strong>Login / Signup</strong> to create an account (teacher by default).</li>
        <li>Go to <strong>Apply for Leave</strong> to submit a request.</li>
        <li>Use the <strong>Approvals</strong> page (visible to HOD/Registrar) to approve or forward requests.</li>
      </ol>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal fade" id="authModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login / Signup</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="auth-msg" aria-live="polite" class="mb-2"></div>
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" name="fullName">

          <select id="role" class="form-control mb-2">
            <option value="teacher">Teacher</option>
            <option value="hod">Head of Dept (HOD)</option>
            <option value="registrar">Registrar</option>
          </select>

          <!-- ADD THIS DEPARTMENT FIELD -->
          <div id="department-group" style="display: none;">
            <label class="form-label">Department</label>
            <select id="department" class="form-control mb-2">
              <option value="">Select Department</option>
              <!-- Departments will be populated automatically by JavaScript -->
            </select>
          </div>
          <input class="form-control mb-2" id="email" placeholder="Email" />
          <input class="form-control mb-2" id="password" type="password" placeholder="Password" />
          <div class="d-flex justify-content-between">
            <button class="btn btn-primary" id="btn-signup">Sign up</button>
            <button class="btn btn-success" id="btn-login">Log in</button>
            <button class="btn btn-outline-danger" id="btn-logout" style="display:none">Log out</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modules -->
  <script type="module">
    import { initAuthHandlers } from './js/auth.js';
    // initialize auth handlers (signup/login/logout, onAuthStateChanged inside auth.js)
    initAuthHandlers();

    // show auth modal when button clicked
    document.getElementById('open-auth').addEventListener('click', () => {
      const modalEl = document.getElementById('authModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    });

    // Role-based visibility for Approvals link:
    // Import Firebase auth+db and helper methods to read users/{uid} role
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const approvalsLink = document.getElementById('approvals-link');
    const userArea = document.getElementById('user-area');

    // Keep a small UI updater for the signed-in user display
    function updateUserAreaUI(user, profile) {
      if (!user) {
        userArea.innerHTML = '<div class="text-muted">Not logged in</div>';
        return;
      }
      const displayName = profile?.fullName || user.displayName || user.email;
      const teacherId = profile?.teacherId ? `<div><small>Teacher ID: ${profile.teacherId}</small></div>` : '';
      const role = profile?.role ? `<div><small>Role: ${profile.role}</small></div>` : '';
      userArea.innerHTML = `<div class="card p-2"><strong>${displayName}</strong>${teacherId}${role}</div>`;
    }

    // Watch auth state to toggle Approvals button (only for hod/registrar)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        approvalsLink.style.display = 'none';
        updateUserAreaUI(null, null);
        return;
      }

      // try to read users/{uid} doc to find role (safe for MVP)
      try {
        const udocRef = doc(db, 'users', user.uid);
        const snap = await getDoc(udocRef);
        const profile = snap.exists() ? snap.data() : null;

        const role = profile?.role || null;
        if (role && (role === 'hod' || role === 'registrar')) {
          approvalsLink.style.display = 'inline-block';
        } else {
          approvalsLink.style.display = 'none';
        }

        // update user area with profile info
        updateUserAreaUI(user, profile);
      } catch (e) {
        console.warn('Failed to read user profile for role visibility', e);
        approvalsLink.style.display = 'none';
        updateUserAreaUI(user, null);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>